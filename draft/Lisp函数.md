Title: Lisp 学习笔记--函数
Tags: Lisp, 学习, 笔记, 函数
Category: 函数
Date: 2013-03-20

## 定义
函数一般使用`DEFUN`宏来定义.下面是`DEFUN`的基本结构
```lisp
(defun name (parameter*)
  "Optional documentation string"
  body-form*)
```
函数名可以是任何符号.函数的形参列表定义了一些变量, 用来保存函数在调用时所传递的实参.可以使用`DOCUMENTATION`函数来获取紧跟函数`形参`列表之后的`文档字符串`.最后函数主体可以有任意数量的Lisp表达式构成,并将会被依次求值,并返回最后一个值.也可以使用`RETURN-FROM`特殊操作符从函数任意位置返回


## 形参列表
`形参列表`的基本用途是为了声明一些变量,用来接受传递给函数的实参.

### 必要形参
当`形参列表`是由变量名组成的简单列表时, 这些形参被成为`必要形参`.也就说调用函数时必须传递这些参数.

### 可选形参
在`必要形参`的名字之后放置符号`&optional`,后接可选形参的名字:
```lisp
(defun foo (a b &optional c d) (list a b c d))
```
如果`可选形参`在调用时没有传递则为`NIL`, 也可以简单的提供一个值作为表达式:
```lisp
(defun foo (a &optional (b 10)) (list a b))
```
这样函数调用时`可选形参` `b`如果没有指定则默认为`10`

同时`可选形参`的默认值可以引用`必要形参`的值:
```lisp
(defun make-rectangle (width &optional (height width)))
```

同时可以在指定`可选形参`默认值时可以带有一个`supplied-p`的后缀, 当`supplied-p`的值为`NIL`时则说明使用的`可选形参`的默认值,否则是调用函数传递的值:
```lisp
(defun foo (a b &optional (c 3 c-p))
    (list a b c c-p))
```
下面是调用结果
```
(foo 1 2)   -> (1 2 3 NIL)
(foo 1 2 3) -> (1 2 3 T)
(foo 1 2 4) -> (1 2 4 T)
```

### 变长形参
当不确定形参表长度时可以使用`变长形参`(剩余形参), Lisp允许在符号`&rest`之后包含任意数目形参.任何没有被其他形参收集的参数将会被收集到`&rest`后的列表变量中

### 关键字形参
`关键字形参`允许调用使用者执行具体形参相应所使用的值, 可以在任何必要的`&optional`和`&rest&`形参之后加上符号`&key`以及任意数量的关键字形参标识符:
```lisp
(defun foo (&key a b c) (list a b c))
```
可以使用如下方法调用:
```lisp
(foo)           -> (NIL NIL NIL)
(foo :a 1)      -> (1 NIL NIL)
(foo :b 1)      -> (NIL 1 NIL)
(foo :a 1 :c 3) -> (1 NIL 3)
```
和`可选形参`一样可以为`关键字形参`提供一个默认列表并且可以后缀 `supplied-p`来判断是调用时传递还是使用的默认值
```lisp
(defun foo (&key (a 0) (b 3 b-p))
    (list a b b-p))
```
如果不想让调用这用来指定形参关键字不同于实际实参名, 可以将形参名替换成一个列表, 令其含有调用函数时使用的关键字已经作用的形参的名字
```lisp
(defun foo (&key ((:apple a)) ((:box b) 0) ((:charlie c) 0 c-p))
  (list a b c c-p))
```

### 形参类型顺序
当一个函数需要使用4种形参类型的情况下必须以这样的顺序声明:
首先是`必要形参`, 其次是`可选形参`,再次是`剩余形参`,最后才是`关键字形参`

将`&optinal`形参和`&key`形参组合使用时将产生非常奇怪的错误, 所以尽量避免它们一起使用


## 函数返回值
函数默认返回最后一个表达式的值.也可以使用`RETURN-FROM`特殊操作符, 它能够立即以任何值从函数中间返回.并且不仅仅从函数中返回还可以从`BLOCK`特殊操作符所定义的代码块中返回

`RETURY-FROM`是一个特殊操作符, 第一个"参数"是它想要返回的代码块名称.该名字不被求值, 因此无须引用
```lisp
(defun foo (n)
  (dotimes (i 10)
    (dotimes (j 10)
      (when (> (* i j) n)
        (return-from foo (list i j))))))
```

## 作为数据的函数-----高阶函数
操作符`FUNCTION`提供了一个获取函数对象的方法.它接受单衣参数并返回与该参数同名的函数,同时可以是使用`#'`来代替`FUNCTION`

Common Lisp提供了两个函数用来通过函数对象来调用函数:`FUNCALL`和`APPLY`

### FUNCALL
`FUNCALL`用于在编写代码时确切的知道传递给函数多少实参, 它的第一个参数是被调用的`函数对象`, 其余的参数被传递到函数中

### APPLY
`APPLY`用于在实参列表只在运行期得知时,它第一个参数是一个`函数对象`,但在这之后它期待一个列表而非单独的实参,它将函数应用在列表上的值上.

`APPLY`还接受鼓励的实参, 只要最后一个实参是个列表

## 匿名函数
`LAMBDA`表达式可以创建一个匿名函数
