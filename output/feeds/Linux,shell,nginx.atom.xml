<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Wood.D's Record</title><link href="http://www.linuxzen.com/" rel="alternate"></link><link href="http://www.linuxzen.com/feeds/Linux,shell,nginx.atom.xml" rel="self"></link><id>http://www.linuxzen.com/</id><updated>2012-02-17T10:27:00+08:00</updated><entry><title>编写Linux shell脚本来实现nginx日志分割</title><link href="http://www.linuxzen.com/bian-xie-linux-shelljiao-ben-lai-shi-xian-nginxri-zhi-fen-ge.html" rel="alternate"></link><updated>2012-02-17T10:27:00+08:00</updated><author><name>Wood.D</name></author><id>tag:www.linuxzen.com,2012-02-17:bian-xie-linux-shelljiao-ben-lai-shi-xian-nginxri-zhi-fen-ge.html</id><summary type="html">&lt;p&gt;nginx的accss日志每天都会产生大量的日志,不过不进行切割会使查看日志变得异常艰难,这里编写一个脚本结合crond来实现nginx的日志切割,切割的格式为日志后缀的数字越小表示离当前日期越近,比如access.log.2存放的内容要比access.log.1的内容要早.&lt;/p&gt;
&lt;p&gt;好了,废话不多说,脚本内容如下:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span class="c"&gt;#!/bin/sh&lt;/span&gt;
&lt;span class="c"&gt;# Author   : cold night&lt;/span&gt;
&lt;span class="c"&gt;# Filename : nglogcut.sh&lt;/span&gt;
&lt;span class="nb"&gt;export &lt;/span&gt;&lt;span class="nv"&gt;PATH&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;/usr/kerberos/sbin:/usr/kerberos/bin:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin
&lt;span class="nv"&gt;LogPath&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/usr/local/nginx/logs/access.log&amp;#39;&lt;/span&gt;    &lt;span class="c"&gt;# 定义日志绝对路径&lt;/span&gt;

&lt;span class="k"&gt;for &lt;/span&gt;i in &lt;span class="sb"&gt;`&lt;/span&gt;ls &lt;span class="nv"&gt;$LogPath&lt;/span&gt;* | awk -F&lt;span class="s1"&gt;&amp;#39;/&amp;#39;&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;{print $NF}&amp;#39;&lt;/span&gt; | sort -nr&lt;span class="sb"&gt;`&lt;/span&gt;
&lt;span class="k"&gt;do&lt;/span&gt;
&lt;span class="k"&gt;        &lt;/span&gt;&lt;span class="nv"&gt;LastNum&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="sb"&gt;`&lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="nv"&gt;$i&lt;/span&gt; | awk -F&lt;span class="s1"&gt;&amp;#39;.&amp;#39;&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;{print $NF}&amp;#39;&lt;/span&gt;&lt;span class="sb"&gt;`&lt;/span&gt;

        &lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="nv"&gt;$LastNum&lt;/span&gt; | grep -E &lt;span class="s2"&gt;&amp;quot;[0-9]+&amp;quot;&lt;/span&gt; 2&amp;amp;gt;/dev/null 1&amp;amp;gt;&amp;amp;amp;2
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;[[&lt;/span&gt; &lt;span class="nv"&gt;$?&lt;/span&gt; -eq 0 &lt;span class="o"&gt;]]&lt;/span&gt;
        &lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="k"&gt;                &lt;/span&gt;&lt;span class="nv"&gt;OnNum&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="sb"&gt;`&lt;/span&gt;expr &lt;span class="nv"&gt;$LastNum&lt;/span&gt; + 1&lt;span class="sb"&gt;`&lt;/span&gt;
                mv &lt;span class="nv"&gt;$LogPath&lt;/span&gt;.&lt;span class="nv"&gt;$LastNum&lt;/span&gt; &lt;span class="nv"&gt;$LogPath&lt;/span&gt;.&lt;span class="nv"&gt;$OnNum&lt;/span&gt;
        &lt;span class="k"&gt;else&lt;/span&gt;
&lt;span class="k"&gt;                &lt;/span&gt;mv &lt;span class="nv"&gt;$LogPath&lt;/span&gt; &lt;span class="nv"&gt;$LogPath&lt;/span&gt;.1
                &lt;span class="nb"&gt;kill&lt;/span&gt; -HUP &lt;span class="sb"&gt;`&lt;/span&gt;cat /usr/local/nginx/logs/nginx.pid&lt;span class="sb"&gt;`&lt;/span&gt;
        &lt;span class="k"&gt;fi&lt;/span&gt;
&lt;span class="k"&gt;done&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;然后保存为nglogcut.sh存放在/root/下,下面给脚本赋予执行权限&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;chmod +x /root/nglogcut.sh
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;配置crond自动执行:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;crontab -e    &lt;span class="c"&gt;# 执行crontab -e为当前用户添加,但必须要再脚本前面声明PATH路径,或命令用绝对路径&lt;/span&gt;

&lt;span class="c"&gt;# 添加如下内容:&lt;/span&gt;
00 2 */3 * * /bin/sh /root/nglogcut.sh 2&amp;amp;gt; /dev/null 1&amp;amp;gt;&amp;amp;amp;2 &lt;span class="c"&gt;# 每3天执行日志分割(可根据自己情况来定义执行周期)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;</summary><category term="日志"></category><category term="分割"></category><category term="shell"></category><category term="nginx"></category><category term="log"></category><category term="Linux"></category><category term="cut"></category></entry></feed>