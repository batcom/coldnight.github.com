<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Wood's Linux Zen</title><link href="http://localhost/" rel="alternate"></link><link href="http://localhost/feeds/Linux,MySQL,nginx,%E7%9B%91%E6%8E%A7.atom.xml" rel="self"></link><id>http://localhost/</id><updated>2012-03-14T14:02:00+08:00</updated><entry><title>使用cacti构建监控系统</title><link href="http://localhost/shi-yong-cactigou-jian-jian-kong-xi-tong.html" rel="alternate"></link><updated>2012-03-14T14:02:00+08:00</updated><author><name>Wood</name></author><id>tag:localhost,2012-03-14:shi-yong-cactigou-jian-jian-kong-xi-tong.html</id><summary type="html">&lt;p&gt;Cacti是一套基于PHP,MySQL,SNMP及RRDTool开发的网络流量监测图形分析工具,它是通过 snmpget来获取数据，使用 RRDtool绘画图形,可以指定每一个用户能查看树状结构、host以及任何一张图，还可以与LDAP结合进行用户验证，同时也能自己增加模板，功能非常强大完善。界面友好。&lt;/p&gt;
&lt;p&gt;cacti是用php语言实现的一个软件，它的主要功能是用snmp服务获取数据，然后用rrdtool储存和更新数据，当用户需要查看数据的时候用rrdtool生成图表呈现给用户。因此，snmp和rrdtool是cacti的关键。Snmp关系着数据的收集，rrdtool关系着数据存储和图表的生成。&lt;/p&gt;
&lt;p&gt;cacti依赖于PHP+MYSQL环境,前面的几篇文章已经详细讲解了如何在Linux部署LNMP环境,这篇文章我们就是用前面几章所搭建的环境,所以这里不再讲解如何搭建环境,如果您不会可以先看看前几篇文章.&lt;/p&gt;
&lt;p&gt;下面就介绍如何来部署cacti.&lt;/p&gt;
&lt;p&gt;首先介绍本文所使用的环境:
server:&lt;/p&gt;
&lt;p&gt;系统为CentOS 5.5 32bit&lt;/p&gt;
&lt;p&gt;ip:192.168.3.120&lt;/p&gt;
&lt;p&gt;cacti:cacti-0.8.7i.tar.gz&lt;/p&gt;
&lt;p&gt;cacti使用SNMP采集数据,首先安装snmp数据采集工具:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;yum -y install lm_sensors net-snmp net-snmp-utils
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;同时cacti又依赖于rrdtool生成图表所以首先安装rrdtool:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;wget http://oss.oetiker.ch/rrdtool/pub/rrdtool-1.4.7.tar.gz
yum -y install cairo-devel glib2-devel pango-devel intltool   &lt;span class="c"&gt;# 安装rrdtool依赖&lt;/span&gt;
./configure --prefix&lt;span class="o"&gt;=&lt;/span&gt;/usr/local
make &amp;amp;amp;&amp;amp;amp; make install
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;下面就来下载cacti安装:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;wget http://www.cacti.net/downloads/cacti-0.8.7i.tar.gz
tar -zxvf cacti-0.8.7i.tar.gz
cp -r cacti-0.8.7i /usr/local/nginx/html/cacti  &lt;span class="c"&gt;# 复制到html目录&lt;/span&gt;
useradd cactiuser -M -s /sbin/nologin          &lt;span class="c"&gt;# 创建cacti用户&lt;/span&gt;
chown -R cactiuser.cactiuser /usr/local/nginx/html/cacti/rra/ &lt;span class="c"&gt;# 改变属主和属组&lt;/span&gt;
chown -R cactiuser.cactiuser /usr/local/nginx/html/cacti/log/
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;然后进入到数据库创建cacti数据和创建一个用户:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;create database cactidb default character &lt;span class="nb"&gt;set &lt;/span&gt;utf8;   &lt;span class="c"&gt;#创建数据库&lt;/span&gt;
grant all on cactidb.* to cactiuser@localhost identified by &lt;span class="s1"&gt;&amp;#39;123456&amp;#39;&lt;/span&gt;; &lt;span class="c"&gt;# 创建一个mysql用户&lt;/span&gt;
use cactidb   &lt;span class="c"&gt;# 使用刚才创建的数据库&lt;/span&gt;
&lt;span class="nb"&gt;source&lt;/span&gt; /usr/local/nginx/html/cacti/cacti.sql &lt;span class="c"&gt;# 导入cacti数据&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;接下来我们编辑cacti配置文件/usr/local/nginx/html/cacti/include/config.php&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; /usr/local/nginx/html/cacti/
vi include/config.php
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;编辑下面内容:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span class="nv"&gt;$database_type&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;mysql&amp;quot;&lt;/span&gt;;            &lt;span class="c"&gt;# 数据库类型&lt;/span&gt;
&lt;span class="nv"&gt;$database_default&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;cactidb&amp;quot;&lt;/span&gt;;       &lt;span class="c"&gt;# 数据库名字&lt;/span&gt;
&lt;span class="nv"&gt;$database_hostname&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;localhost&amp;quot;&lt;/span&gt;;    &lt;span class="c"&gt;# 数据库主机&lt;/span&gt;
&lt;span class="nv"&gt;$database_username&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;cactiuser&amp;quot;&lt;/span&gt;;    &lt;span class="c"&gt;# 数据库用户&lt;/span&gt;
&lt;span class="nv"&gt;$database_password&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;123456&amp;quot;&lt;/span&gt;;       &lt;span class="c"&gt;# 数据库密码&lt;/span&gt;
&lt;span class="nv"&gt;$database_port&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;3306&amp;quot;&lt;/span&gt;;             &lt;span class="c"&gt;# 数据库端口&lt;/span&gt;
&lt;span class="nv"&gt;$database_ssl&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;false&lt;/span&gt;;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;然后修改nginx配置文件像下面:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;        location / &lt;span class="o"&gt;{&lt;/span&gt;
            root   html;
            index  index.php;
        &lt;span class="o"&gt;}&lt;/span&gt;

        location ~ &lt;span class="se"&gt;\.&lt;/span&gt;php&lt;span class="nv"&gt;$ &lt;/span&gt;&lt;span class="o"&gt;{&lt;/span&gt;
            fastcgi_pass        unix:/var/run/php-fpm/php-fpm.sock;
            fastcgi_index       index.php;
            fastcgi_param SCRIPT_FILENAME &lt;span class="nv"&gt;$document_root&lt;/span&gt;/&lt;span class="nv"&gt;$fastcgi_script_name&lt;/span&gt;;
            include fastcgi_params;
            include fastcgi.conf;
        &lt;span class="o"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;重启nginx&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;pkill -9 nginx
/usr/local/nginx/sbin/nginx
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;然后设置php时区,&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; /usr/local/nginx/html/cacti/
vi include/global_constants.php
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;在第二行添加&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;date_default_timezone_set&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Asia/Chongqing&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;接下来配置snmp,编辑/etc/snmp/snmpd.conf&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;vi /etc/snmp/snmpd.conf
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;然后找到41行将public改成一个较为复杂的名字:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;com2sec notConfigUser  default       public
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;然后找到62行&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;access  notConfigGroup &lt;span class="s2"&gt;&amp;quot;&amp;quot;&lt;/span&gt;      any       noauth    exact  systemview none none
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;将systemview改成all:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;access  notConfigGroup &lt;span class="s2"&gt;&amp;quot;&amp;quot;&lt;/span&gt;      any       noauth    exact  all none none
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;然后去掉85行的注释:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;view all    included  .1                               80
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;保存配置文件后启动snmp&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;service snmpd start
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;然后在浏览器里输入:http://192.168.3.120/cacti/
然后根据提示一步步安装,安装好后使用admin密码admin登录.如果点击graphs不能显示图像的话执行:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;php /usr/local/nginx/html/cacti/poller.php   &lt;span class="c"&gt;# nginx下不会自动生成*.rrd文件必须手动执行这条命令才会生成,Debug没报错,测试权限也没问题,不知道怎么回事,望知道的能告知小弟&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;为了方便把这句加入到cron,执行:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;yum -y install vixie-cron  &lt;span class="c"&gt;#安装&lt;/span&gt;
service crond start
crontab -e
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;添加如下内容:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;*/5 * * * * /usr/bin/php /usr/local/nginx/html/cacti/poller.php
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;好了这时候我们就可以打开查看生成的图像了.
注意如果报如下错误:
Call to undefined function session_unregister()
将session_unregister('username') 改成
$_SESSION['username']='';&lt;/p&gt;</summary><category term="监控"></category><category term="lnmp"></category><category term="Linux"></category><category term="CentOS"></category><category term="cacti"></category></entry></feed>