<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Wood's Linux Zen</title><link href="http://www.linuxzen.com/" rel="alternate"></link><link href="http://www.linuxzen.com/feeds/Linux,shell,%E7%9B%91%E6%8E%A7,Python.atom.xml" rel="self"></link><id>http://www.linuxzen.com/</id><updated>2012-05-18T11:16:00+08:00</updated><entry><title>使用Linux shell实时检测文件变更</title><link href="http://www.linuxzen.com/shi-yong-linux-shellshi-shi-jian-ce-wen-jian-bian-geng.html" rel="alternate"></link><updated>2012-05-18T11:16:00+08:00</updated><author><name>Wood</name></author><id>tag:www.linuxzen.com,2012-05-18:shi-yong-linux-shellshi-shi-jian-ce-wen-jian-bian-geng.html</id><summary type="html">&lt;p&gt;使用python做web开发,现在流行使用uwsgi调用python程序,但是使用uwsgi一段时间发现有一个弊端,就是每次更改源代码后必须重启uwsgi才能生效,包括更改模板文件也是,我是个懒人,再经过一段时间反复的更改-重启后我终于忍受不了,决定写一个脚本来定时程序目录的文件改动,并及时自动重启uwsgi,来解放我的双手可以不用理会这些琐碎的重启工作. 用了点时间来编写了一个脚本用来判断是否更改,然后判断是否需要重启uwsgi.&lt;/p&gt;
&lt;p&gt;下面放出脚本内容:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span class="c"&gt;#!/bin/bash&lt;/span&gt;
&lt;span class="c"&gt;# Author      : cold&lt;/span&gt;
&lt;span class="c"&gt;# Homepage    : http://www.linuxzen.com&lt;/span&gt;
&lt;span class="c"&gt;# Filename    : checkchange.sh&lt;/span&gt;
&lt;span class="c"&gt;# Useage      : sh checkchange.sh [dir]&lt;/span&gt;
checkisdir&lt;span class="o"&gt;()&lt;/span&gt;
        &lt;span class="c"&gt;# Have one argument&lt;/span&gt;
        &lt;span class="c"&gt;# The argument is a directory&lt;/span&gt;
        &lt;span class="k"&gt;for &lt;/span&gt;i in &lt;span class="sb"&gt;`&lt;/span&gt;ls &lt;span class="nv"&gt;$1&lt;/span&gt; | sed -e &lt;span class="s1"&gt;&amp;#39;s/ /\n/g&amp;#39;&lt;/span&gt;&lt;span class="sb"&gt;`&lt;/span&gt;
        &lt;span class="k"&gt;do&lt;/span&gt;
&lt;span class="k"&gt;                if&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt; -d &lt;span class="nv"&gt;$1&lt;/span&gt;/&lt;span class="nv"&gt;$i&lt;/span&gt; &lt;span class="o"&gt;]&lt;/span&gt;
                &lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="k"&gt;                        if&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt; &lt;span class="nv"&gt;$i&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;bin&amp;quot;&lt;/span&gt; -o &lt;span class="nv"&gt;$i&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;lib&amp;quot;&lt;/span&gt; -o &lt;span class="nv"&gt;$i&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;include&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;]&lt;/span&gt;   &lt;span class="c"&gt;# 不想检测的目录(这里是使用virtualenv生成的环境文件)&lt;/span&gt;
                        &lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="k"&gt;                                continue&lt;/span&gt;
&lt;span class="k"&gt;                        fi&lt;/span&gt;
&lt;span class="k"&gt;                        &lt;/span&gt;&lt;span class="nv"&gt;dir&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;$1/$i&amp;quot;&lt;/span&gt;
                        checkisdir &lt;span class="nv"&gt;$dir&lt;/span&gt;
                &lt;span class="k"&gt;else&lt;/span&gt;
&lt;span class="k"&gt;                        &lt;/span&gt;&lt;span class="nv"&gt;files&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nv"&gt;$files&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;\n&amp;#39;&lt;/span&gt;&lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/&amp;#39;&lt;/span&gt;&lt;span class="nv"&gt;$i&lt;/span&gt;
                &lt;span class="k"&gt;fi&lt;/span&gt;
&lt;span class="k"&gt;        done&lt;/span&gt;
&lt;span class="k"&gt;        &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt; -e &lt;span class="nv"&gt;$files&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;
&lt;span class="k"&gt;while &lt;/span&gt;&lt;span class="nb"&gt;true&lt;/span&gt;
&lt;span class="k"&gt;do&lt;/span&gt;
&lt;span class="k"&gt;        if&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt; -e /tmp/stat.tmp &lt;span class="o"&gt;]&lt;/span&gt;
        &lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="k"&gt;                for &lt;/span&gt;i in &lt;span class="sb"&gt;`&lt;/span&gt;checkisdir &lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="sb"&gt;`&lt;/span&gt;
                &lt;span class="k"&gt;do&lt;/span&gt;
&lt;span class="k"&gt;                        if&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt; -e /tmp/patch.tmp &lt;span class="o"&gt;]&lt;/span&gt;
                        &lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="k"&gt;                                &lt;/span&gt;stat &lt;span class="nv"&gt;$i&lt;/span&gt; | grep Change &amp;gt; /tmp/nstat.tmp
                                rm -f /tmp/patch.tmp
                                &lt;span class="k"&gt;continue&lt;/span&gt;
&lt;span class="k"&gt;                        fi&lt;/span&gt;
&lt;span class="k"&gt;                        &lt;/span&gt;stat &lt;span class="nv"&gt;$i&lt;/span&gt; | grep Change &amp;gt;&amp;gt; /tmp/nstat.tmp
                &lt;span class="k"&gt;done&lt;/span&gt;
&lt;span class="k"&gt;                &lt;/span&gt;diff /tmp/stat.tmp /tmp/nstat.tmp &amp;gt; /tmp/patch.tmp
                &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt; &lt;span class="nv"&gt;$?&lt;/span&gt; -eq 0 &lt;span class="o"&gt;]&lt;/span&gt;
                &lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="k"&gt;                        &lt;/span&gt;sleep 10
                &lt;span class="k"&gt;else&lt;/span&gt;
                        /etc/init.d/uwsgi.py restart                    &lt;span class="c"&gt;# 将此处更改为想要做的操作&lt;/span&gt;
                        patch /tmp/stat.tmp /tmp/patch.tmp
                &lt;span class="k"&gt;fi&lt;/span&gt;
&lt;span class="k"&gt;        else&lt;/span&gt;
&lt;span class="k"&gt;                for &lt;/span&gt;i in &lt;span class="sb"&gt;`&lt;/span&gt;checkisdir &lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="sb"&gt;`&lt;/span&gt;
                &lt;span class="k"&gt;do&lt;/span&gt;
&lt;span class="k"&gt;                        &lt;/span&gt;stat &lt;span class="nv"&gt;$i&lt;/span&gt; | grep Change &amp;gt;&amp;gt; /tmp/stat.tmp
                &lt;span class="k"&gt;done&lt;/span&gt;
&lt;span class="k"&gt;                continue&lt;/span&gt;
&lt;span class="k"&gt;        fi&lt;/span&gt;
&lt;span class="k"&gt;done&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;这里主要测试变更后重启uwsgi,使用方法:我的bottle程序在/code/python下:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;sh checkchange.sh /code/python &amp;amp;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;如果使用svn可以参考下面代码:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span class="c"&gt;#!/bin/bash&lt;/span&gt;
&lt;span class="c"&gt;# Author        : cold&lt;/span&gt;
&lt;span class="c"&gt;# Homepage      : http://www.linuxzen.com&lt;/span&gt;
&lt;span class="c"&gt;# Filename      : checkupdate.sh&lt;/span&gt;
&lt;span class="c"&gt;# Describle     : To Check update of svn&lt;/span&gt;

&lt;span class="k"&gt;while &lt;/span&gt;&lt;span class="nb"&gt;true&lt;/span&gt;
&lt;span class="k"&gt;do&lt;/span&gt;
&lt;span class="k"&gt;        &lt;/span&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; /code/python
        svn up | grep At &amp;gt; /dev/null 2&amp;gt;&amp;amp;1
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt; &lt;span class="nv"&gt;$?&lt;/span&gt; -eq 0 &lt;span class="o"&gt;]&lt;/span&gt;
        &lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="k"&gt;                &lt;/span&gt;sleep 30
        &lt;span class="k"&gt;fi&lt;/span&gt;

&lt;span class="k"&gt;        &lt;/span&gt;svn up | grep Updated &amp;gt; /dev/null 2&amp;gt;&amp;amp;1
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt; &lt;span class="nv"&gt;$?&lt;/span&gt; -eq 0 &lt;span class="o"&gt;]&lt;/span&gt;
        &lt;span class="k"&gt;then&lt;/span&gt;
                /etc/init.d/uwsgi.py restart
        &lt;span class="k"&gt;fi&lt;/span&gt;
&lt;span class="k"&gt;done&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;</summary><category term="检测"></category><category term="文件"></category><category term="实时"></category><category term="变更"></category><category term="uwsgi"></category><category term="shell"></category><category term="python"></category><category term="Linux"></category><category term="bottle"></category></entry></feed>