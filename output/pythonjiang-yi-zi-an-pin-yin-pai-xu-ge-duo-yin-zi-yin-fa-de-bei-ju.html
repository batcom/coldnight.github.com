<!DOCTYPE html>
<html lang="en">
    <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
        <title>Python将汉字按拼音排序--一个多音字引发的悲剧</title>
        <meta charset="utf-8" />
        <link href='http://fonts.googleapis.com/css?family=ABeeZee|Carrois+Gothic|Source+Code+Pro:400,700' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="./theme/style/reset.css" type="text/css" />
        <link rel="stylesheet" href="./theme/style/screen.css" type="text/css" />
        <link rel="stylesheet" href="./theme/style/print.css" type="text/css" media="print" />
                                <!--[if IE]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
</head>
<body>
    <header id="main">
        <div class="container">
            <div class="logo">
                <a href="/index.html" title="Home">Wood.D's World</a>
            </div>
        </div>
    </header>

    <div class="splash">
        <div class="container">
            <div class="welcome">木秀于林</div>
        </div>
    </div>

    <div class="container content">
        <article>
    <header>
        <h2><a href="/pythonjiang-yi-zi-an-pin-yin-pai-xu-ge-duo-yin-zi-yin-fa-de-bei-ju.html" rel="bookmark">
    Python将汉字按拼音排序--一个多音字引发的悲剧
</a></h2>
<time datetime="2012-10-24 18:29:00" pubdate>Posted on
    三 24 十月 2012
</time>
<address class="vcard author">
    by <a class="url fn" href="./author/woodd.html">
    Wood.D</a>
</address>
<span class="category">in <a href="./category/python.html">
    Python</a>.
        </span>
    </header>

    <div class="body">
        <p>今天同事告诉我一个项目需要将汉字按拼音排序,之前没做过啊,就google之,down了一份汉字与拼音的对照表,对照表格式如下:</p>
<div class="codehilite"><pre><span class="err">拼</span>    <span class="n">pin1</span>
<span class="err">音</span>    <span class="n">yin1</span>
</pre></div>


<p>将文件保存为<code>pinyindata</code>,于是有了如下对应的python代码:</p>
<div class="codehilite"><pre><span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding:utf-8 -*-</span>
<span class="c">#</span>
<span class="c"># Author : cold night</span>
<span class="c"># E-mail : wh_linux@126.com</span>
<span class="c"># Date   : 12-10-24 下午3:13</span>
<span class="c">#</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">import</span> <span class="nn">locale</span>

<span class="k">class</span> <span class="nc">SortedByPy</span><span class="p">:</span>
    <span class="n">__PYDICT__</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">PYDATA_PATH</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="s">&#39;pinyindata&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__PYDICT__</span><span class="p">:</span>
            <span class="n">py_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PYDATA_PATH</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">py_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="n">word</span><span class="p">,</span> <span class="n">pinyin</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__PYDICT__</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">word</span><span class="p">:</span><span class="n">pinyin</span><span class="o">.</span><span class="n">strip</span><span class="p">()})</span>
            <span class="n">py_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_py</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        获取汉字拼音</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__PYDICT__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">cmp_by_py</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        使用拼音比较两个汉字的先后(使用倒序)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">r1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_py</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_py</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">cmp</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        - `iterable` :</span>
<span class="sd">        - `key` : 有则对列表中的字典对应key的值进行排序</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">key</span> <span class="k">else</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">f</span> <span class="o">&lt;=</span> <span class="s">&#39;z&#39;</span><span class="p">:</span><span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iterable</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">cmp</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmp_by_py</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">key</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span> <span class="n">reverse</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="nb">cmp</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmp_by_py</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">key</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="nb">cmp</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmp_by_py</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="n">l</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</pre></div>


<p>嗯,写好后测试正常,提交后告诉同事,同事一测发现重庆怎么跑到最后啊,不对啊,有bug啊,我重新将重庆加入到我的测试,真是不行阿,好吧可能是对照表的问题,打开找了下,能找到重啊,难道是decode出问题了,于是打开咱的ipython shell,结果输入重庆,一回车终端崩了,好吧,我再试还是崩,于是我想可能是utf-8的bug或者python的uft-8的bug,于是我将我的想法告知了同事,同事也打开了<code>ipython试</code>了下,结果他的可以正常输入,正常decode/encode,这下我想可能是方法的问题吧.</p>
<p>于是看看有无别的办法,看到一个对Linux有效可能对window有效的办法,好嘛正好咱也Linux果断拿过来试试,于是下面的代码诞生了:</p>
<div class="codehilite"><pre><span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding:utf-8 -*-</span>
<span class="c">#</span>
<span class="c"># Author : cold night</span>
<span class="c"># E-mail : wh_linux@126.com</span>
<span class="c"># Date   : 12-10-24 下午3:13</span>
<span class="c">#</span>
<span class="c">#from os import path</span>
<span class="kn">import</span> <span class="nn">locale</span>

<span class="k">class</span> <span class="nc">SortedByPy</span><span class="p">:</span>
    <span class="n">__PYDICT__</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="c">#PYDATA_PATH = path.join(path.dirname(__file__), &#39;pinyindata&#39;)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        if not self.__PYDICT__:</span>
<span class="sd">            py_file = open(self.PYDATA_PATH, &#39;r&#39;)</span>
<span class="sd">            for line in py_file.readlines():</span>
<span class="sd">                word, pinyin = line.split(&#39;\t&#39;)</span>
<span class="sd">                self.__PYDICT__.update({word:pinyin.strip()})</span>
<span class="sd">            py_file.close()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">get_py</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        获取汉字拼音</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__PYDICT__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">cmp_by_py</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        使用拼音比较两个汉字的先后(使用倒序)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">r1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_py</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_py</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">cmp</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        - `iterable` :</span>
<span class="sd">        - `key` : 有则对列表中的字典对应key的值进行排序</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        for i,v in enumerate(iterable):</span>
<span class="sd">            f = v[key][0] if key else v[0]</span>
<span class="sd">            if f &lt;= &#39;z&#39;:result.append(iterable.pop(i))</span>
<span class="sd">        if key:</span>
<span class="sd">            result.sort(cmp = lambda x, y: self.cmp_by_py(x[key], y[key]), reverse= reverse)</span>
<span class="sd">        else:</span>
<span class="sd">            result.sort(reverse=reverse)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">locale</span><span class="o">.</span><span class="n">LC_ALL</span><span class="p">,</span> <span class="s">&#39;zh_CN.UTF-8&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="nb">cmp</span><span class="o">=</span><span class="n">locale</span><span class="o">.</span><span class="n">strcoll</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="nb">cmp</span><span class="o">=</span><span class="n">locale</span><span class="o">.</span><span class="n">strcoll</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</pre></div>


<p>写好了跑起来测试嘛,重庆还是躺在了最后,我想这应该就是utf-8的bug了吧,系统都这样了,于是和同事交流后认为也许是bug吧,回到座位后我苦思冥想阿,绞尽脑汁啊,看看有没有别的办法阿,突然一道闪电阿,我明白了,重<code>多音字</code>啊也读<code>zhong</code>啊,排在最后是对的啊,没有错误,也没有bug,一个<code>多音字</code>引发的悲剧哇.</p>
    </div>

        <footer>
        <ul class="tags">            <li>
                <a href="./tag/yi-zi-pai-xu.html">汉字排序</a>
            </li>            <li>
                <a href="./tag/yi-zi.html">汉字</a>
            </li>            <li>
                <a href="./tag/pai-xu.html">排序</a>
            </li>            <li>
                <a href="./tag/pin-yin.html">拼音</a>
            </li>            <li>
                <a href="./tag/duo-yin-zi.html">多音字</a>
            </li>            <li>
                <a href="./tag/python.html">python</a>
            </li>        </ul>
    </footer>
    
        <div id="disqus_thread"></div>
    <script>
        var disqus_identifier = "pythonjiang-yi-zi-an-pin-yin-pai-xu-ge-duo-yin-zi-yin-fa-de-bei-ju.html";
        (function () {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.src = 'http://linuxzen.disqus.com/embed.js';
            (document.head || document.body).appendChild(dsq);
        })();
    </script>
    </article>

<script>
    (function () {
        'use strict';
        var titleElm = document.querySelector('article > header');
        var bodyElm = document.querySelector('article > .body');
        if (!titleElm || !bodyElm)
            return;

        var limit = titleElm.offsetTop;
        var titleCls = titleElm.classList;
        var bodyCls = bodyElm.classList;
        var floating = false;
        window.onscroll = function (evt) {
            var scrollTop = Math.max(document.body.scrollTop,
                    document.documentElement.scrollTop);
            if (!floating && limit <= scrollTop) {
                titleCls.add('float');
                bodyCls.add('body-padding');
                floating = true;
            }
            else if (limit >= scrollTop) {
                titleCls.remove('float');
                bodyCls.remove('body-padding');
                floating = false;
            }
        };
    })();
</script>
    </div>

    <div class="container footnote">
                            </div>

    <div class="bottom">
        <div class="container">
            <div class="about">
                <h3>About me</h3>
                <img alt="Me!" class="avatar"
                     src="http://www.gravatar.com/avatar/d82fd064a3fd1b02c9e77a2d3197e33e?size=64">
                <p>喜欢Linux和Python,用Vim编写程序,曾长时间使用cold这个id,现使用Wood.D作为以后长期id,现在维护一个gtalk群,有兴趣的可以加入,使用xmpp帐号添加:clubot@vim-cn.com`</p>
                                <p>
                   You can contact me by emailing
                   <a href="mailto:wh_linux@126.com">wh_linux@126.com</a>.
                </p>
                <p>
                                                            <a href="https://github.com/coldnight"
                       title="coldnight's Profile">fork me on GitHub</a>!
                                    </p>
            </div>
        </div>
    </div>

    <footer>
        <div class="container footer">
            <span>Powered by <a href="http://docs.getpelican.com">
                Pelican</a> using <a href="https://github.com/BYK/pelican-neat">
                neat theme</a>.
                <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/cn/"><img alt="知识共享许可协议" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/3.0/cn/88x31.png" /></a>本站所有作品均采用<a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/cn/">知识共享署名-相同方式共享 3.0 中国大陆许可协议</a>进行许可。
            </span>
            <nav>
                <ul>
                    <li><a href="archives.html" title="Archive"><strong>Archive</strong></a></li>
                                        <li><a href="https://github.com/coldnight/coldnight.github.com" title="Source code">Source code</a></li>
                                        <li>
                    <script src="http://s96.cnzz.com/stat.php?id=3767683&web_id=3767683&show=pic" language="JavaScript"></script>
                    </li>
                </ul>
            </nav>
                    </div>
    </footer>

    </body>
</html>