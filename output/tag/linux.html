<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title> Linux | cold's world </title>
    <meta name="description" content="">
    <meta name="author" content="cold">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="http://www.linuxzen.com/theme/html5.js"></script>
    <![endif]-->
        <link href="http://www.linuxzen.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="cold's world Atom Feed" />
        
    <!-- Le styles -->
    <link href="http://www.linuxzen.com/theme/bootstrap.min.css" rel="stylesheet">
    <link href="http://www.linuxzen.com/theme/bootstrap.min.responsive.css" rel="stylesheet">
    <link href="http://www.linuxzen.com/theme/local.css" rel="stylesheet">
    <link href="http://www.linuxzen.com/theme/pygments.css" rel="stylesheet">

</head>

<body>

<div class="navbar">
    <div class="navbar-inner">
    <div class="container">

         <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
         </a>

        <a class="brand" href="http://www.linuxzen.com">cold's world</a>

        <div class="nav-collapse">
        <ul class="nav">
            <li><a href="/"> Home </a> </li>
                    
                            <li><a href="http://www.linuxzen.com/pages/about.html">About</a></li>
                        </ul>
        </div>
        
    </div>
    </div>
</div>

<div class="container">
    <div class="content">
    <div class="row">

        <div class="span9">
                

        


    <div class='article'>
        <div class="content-title">
            <a href="http://www.linuxzen.com/shi-yong-geng-jia-gao-xiao-de-epollzuo-wei-pyxmpp2de-zhu-xun-huan.html"><h1>使用更加高效的epoll作为pyxmpp2的主循环</h1></a>
            二 05 二月 2013

by <a class="url fn" href="http://www.linuxzen.com/author/cold.html">cold</a>
 


 
        </div>
        
        <div class="highlight"><h2>引子</h2>
<p>之前<a href="/python-shi-yong-pyxmpp2bian-xie-gtalkqun.html">clubot</a>使用的pyxmpp2的默认mainloop也就是一个poll的主循环,但是<code>clubot</code>上线后资源占用非常厉害,使用<code>strace</code>跟踪发现<code>clubot</code>在不停的<code>poll</code>,查看<code>pyxmpp2</code>代码发现<code>pyxmpp2</code>的<code>poll</code>在使用超时阻塞时使用<code>最小</code>超时时间,而<code>最小</code>超时时间一直是0,所以会变成一个没有超时的非阻塞<code>poll</code>很浪费资源,不打算更改库代码,所以自己仿照poll的mainloop写了一个更加高效的<code>epoll</code>的mainloop</p>
<h2>实现</h2>
<div class="codehilite"><pre><span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding:utf-8 -*-</span>
<span class="c">#</span>
<span class="c">#   Author  :   cold</span>
<span class="c">#   E-mail  :   wh_linux@126.com</span>
<span class="c">#   Date    :   13/01/06 10:41:31</span>
<span class="c">#   Desc    :   Clubot epoll mainloop</span>
<span class="c">#</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">select</span>

<span class="kn">from</span> <span class="nn">pyxmpp2.mainloop.interfaces</span> <span class="kn">import</span> <span class="n">HandlerReady</span><span class="p">,</span> <span class="n">PrepareAgain</span>
<span class="kn">from</span> <span class="nn">pyxmpp2.mainloop.base</span> <span class="kn">import</span> <span class="n">MainLoopBase</span>

<span class="kn">from</span> <span class="nn">plugin.util</span> <span class="kn">import</span> <span class="n">get_logger</span>

<span class="k">class</span> <span class="nc">EpollMainLoop</span><span class="p">(</span><span class="n">MainLoopBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Main event loop based on the epoll() syscall on Linux system &quot;&quot;&quot;</span>
    <span class="n">READ_ONLY</span> <span class="o">=</span> <span class="p">(</span><span class="n">select</span><span class="o">.</span><span class="n">EPOLLIN</span> <span class="o">|</span> <span class="n">select</span><span class="o">.</span><span class="n">EPOLLPRI</span> <span class="o">|</span> <span class="n">select</span><span class="o">.</span><span class="n">EPOLLHUP</span> <span class="o">|</span>
                 <span class="n">select</span><span class="o">.</span><span class="n">EPOLLERR</span> <span class="o">|</span><span class="n">select</span><span class="o">.</span><span class="n">EPOLLET</span><span class="p">)</span>
    <span class="n">READ_WRITE</span> <span class="o">=</span> <span class="n">READ_ONLY</span> <span class="o">|</span> <span class="n">select</span><span class="o">.</span><span class="n">EPOLLOUT</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">handlers</span><span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoll</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">epoll</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unprepared_handlers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exists_fd</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>
        <span class="n">MainLoopBase</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">handlers</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_add_io_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unprepared_handlers</span><span class="p">[</span><span class="n">handler</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configure_io_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_configure_io_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_events</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unprepared_handlers</span><span class="p">:</span>
            <span class="n">old_fileno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unprepared_handlers</span><span class="p">[</span><span class="n">handler</span><span class="p">]</span>
            <span class="n">prepared</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_io_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">old_fileno</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">prepared</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">fileno</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">old_fileno</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">fileno</span> <span class="o">!=</span> <span class="n">old_fileno</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">old_fileno</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exists</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">old_fileno</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epoll</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="n">old_fileno</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">prepared</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unprepared_handlers</span><span class="p">[</span><span class="n">handler</span><span class="p">]</span> <span class="o">=</span> <span class="n">fileno</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">fileno</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">fileno</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span>
        <span class="n">events</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">is_readable</span><span class="p">():</span>
            <span class="n">events</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">READ_ONLY</span>
        <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">is_writable</span><span class="p">():</span>
            <span class="n">events</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">READ_WRITE</span>

        <span class="k">if</span> <span class="n">events</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fileno</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exists_fd</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epoll</span><span class="o">.</span><span class="n">modify</span><span class="p">(</span><span class="n">fileno</span><span class="p">,</span> <span class="n">events</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_exists_fd</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">fileno</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epoll</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">fileno</span><span class="p">,</span> <span class="n">events</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prepare_io_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">HandlerReady</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unprepared_handlers</span><span class="p">[</span><span class="n">handler</span><span class="p">]</span>
            <span class="n">prepared</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">PrepareAgain</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ret</span><span class="o">.</span><span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span><span class="p">,</span> <span class="n">ret</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">timeout</span>
            <span class="n">prepared</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Unexpected result from prepare()&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">prepared</span>

    <span class="k">def</span> <span class="nf">_remove_io_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unprepared_handlers</span><span class="p">:</span>
            <span class="n">old_fileno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unprepared_handlers</span><span class="p">[</span><span class="n">handler</span><span class="p">]</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unprepared_handlers</span><span class="p">[</span><span class="n">handler</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">old_fileno</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">old_fileno</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">old_fileno</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_exists</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">old_fileno</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epoll</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="n">old_fileno</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">loop_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">60</span><span class="p">):</span>
        <span class="n">next_timeout</span><span class="p">,</span> <span class="n">sources_handled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_timeout_handlers</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_events</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quit</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sources_handled</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unprepared_handlers</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_configure_io_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">next_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">next_timeout</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">+=</span> <span class="mi">1</span>    <span class="c"># 带有超时的非阻塞,解约资源</span>
        <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoll</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fd</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">flag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">select</span><span class="o">.</span><span class="n">EPOLLIN</span> <span class="o">|</span> <span class="n">select</span><span class="o">.</span><span class="n">EPOLLPRI</span> <span class="o">|</span> <span class="n">select</span><span class="o">.</span><span class="n">EPOLLET</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">fd</span><span class="p">]</span><span class="o">.</span><span class="n">handle_read</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">flag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">select</span><span class="o">.</span><span class="n">EPOLLOUT</span><span class="o">|</span><span class="n">select</span><span class="o">.</span><span class="n">EPOLLET</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">fd</span><span class="p">]</span><span class="o">.</span><span class="n">handle_write</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">flag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">select</span><span class="o">.</span><span class="n">EPOLLERR</span> <span class="o">|</span> <span class="n">select</span><span class="o">.</span><span class="n">EPOLLET</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">fd</span><span class="p">]</span><span class="o">.</span><span class="n">handle_err</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">flag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">select</span><span class="o">.</span><span class="n">EPOLLHUP</span> <span class="o">|</span> <span class="n">select</span><span class="o">.</span><span class="n">EPOLLET</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">fd</span><span class="p">]</span><span class="o">.</span><span class="n">handle_hup</span><span class="p">()</span>
            <span class="c">#if flag &amp; select.EPOLLNVAL:</span>
                <span class="c">#self._handlers[fd].handle_nval()</span>

            <span class="n">sources_handled</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_configure_io_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">fd</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">sources_handled</span>
</pre></div>


<h2>使用</h2>
<p>如何使用新的mainloop?只需在实例化Client时传入</p>
<div class="codehilite"><pre><span class="n">mainloop</span> <span class="o">=</span> <span class="n">EpollMainLoop</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">my_jid</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="p">,</span> <span class="n">version_provider</span><span class="p">],</span> <span class="n">settings</span><span class="p">,</span> <span class="n">mainloop</span><span class="p">)</span>
</pre></div>


<p>这样就会使用epoll作为mainloop</p>
<h2>注意</h2>
<p>epoll仅仅在<code>Linux</code>下支持</p>
<h2>写在后面的话</h2>
<p>欢迎大家加入到<code>clubot@vim-cn.com</code>中来讨论有关Python/vim/Linux/开源等话题</p></div>
        <hr />
    </div>
		
    
 
        

 

    <div class='article'>
        <a href="http://www.linuxzen.com/linux-xia-shi-yong-pythonjie-tu-zi-dong-fen-xiang.html"><h2>Linux 下使用Python截图自动分享</h2></a>
        <div class= "well small"> 二 22 一月 2013

by <a class="url fn" href="http://www.linuxzen.com/author/cold.html">cold</a>
 


 </div>
        <div class="summary"><h2>引子</h2>
<p>Linux下不支持QQ等功能丰富的IM,虽然可以通过wine运行QQ2012,但是还是喜欢在gtalk群中聊天,gtalk群不支持图片方式,这就要靠我们大家自己来解决了,<a href="http://eleveni386.7axu.com">eleven</a>开放了一个Image上传和显示接口,提供了使用<code>curl</code>来解决,但是我们公司的网络使用<code>squid</code>禁止了<code>curl</code>的访问,所以整天看他们这么爽的分享图片我也不甘心阿,所以就使用Python写了一个分享图片的脚本</p>
<h2>实现</h2>
<p>使用scrot截图,然后使用urllib2库上传图片,如果存在PyQt4库则会将结果放到剪贴板上,如果不存在则输出,自行复制</p>
<h2>代码</h2>
<div class="codehilite"><pre><span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding:utf-8 -*-</span>
<span class="c">#</span>
<span class="c">#   Author  :   cold</span>
<span class="c">#   E-mail  :   wh_linux@126.com</span>
<span class="c">#   Date    :   13/01/21 09:54:39</span>
<span class="c">#   Desc    :   贴代码和图片</span>
<span class="c">#</span>
<span class="kn">import</span> <span class="nn">urllib2</span><span class="o">,</span> <span class="nn">json</span>
<span class="kn">import ...</span></pre></div> <a class="btn btn-info xsmall" href="http://www.linuxzen.com/linux-xia-shi-yong-pythonjie-tu-zi-dong-fen-xiang.html">read more</a></div>
    </div>	
				
    
 
        

 

    <div class='article'>
        <a href="http://www.linuxzen.com/vlogshi-yong-tornadokuang-jia-jie-he-memcachedhuan-cun-ye-mian.html"><h2>vLog使用Tornado框架结合memcached缓存页面</h2></a>
        <div class= "well small"> 三 16 一月 2013

by <a class="url fn" href="http://www.linuxzen.com/author/cold.html">cold</a>
 


 </div>
        <div class="summary"><h2>原因</h2>
<p>Blog是一个更新并不很频繁的一套系统,但是每次刷新页面都要更新数据库反而很浪费资源,添加静态页面生成是一个解决办法,同时缓存是一个更好的主意,可以结合Memcached添加少量的代码进行缓存,而且免去去了每次更新文章都要重新生成静态页面,特别当页面特别多时.</p>
<h2>实现</h2>
<p>主要通过页面的uri进行缓存,结合tornado.web.RequestHandler的prepare和on_finish方法函数,
prepare 主要是请求前执行,on_finish()是请求结束之前执行.在渲染模板时缓存页面内容,然后在请求前检测是否有缓存,如果有直接输出缓存,结束请求,在POST提交之后清空所有缓存,重新生成缓存,从而保证内容实时性.由于登录用户和普通用户的页面不相同,所以不缓存登录用户页面(代码中没有体现,请自行实现).主要python代码(省略了模板渲染的代码):</p>
<div class="codehilite"><pre><span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding:utf-8 -*-</span>
<span class="c">#</span>
<span class="c">#   Author  :   cold</span>
<span class="c">#   E-mail  :   wh_linux@126.com</span>
<span class="c">#   Date    :   13/01/14 09:57:31</span>
<span class="c">#   Desc ...</span></pre></div> <a class="btn btn-info xsmall" href="http://www.linuxzen.com/vlogshi-yong-tornadokuang-jia-jie-he-memcachedhuan-cun-ye-mian.html">read more</a></div>
    </div>	
				
    
 
        

 

    <div class='article'>
        <a href="http://www.linuxzen.com/awesometmuxgnomedoda-zao-gao-xiao-linuxzhuo-mian-huan-jing.html"><h2>Awesome+tmux+gnomeDo打造高效Linux桌面环境</h2></a>
        <div class= "well small"> 二 04 十二月 2012

by <a class="url fn" href="http://www.linuxzen.com/author/cold.html">cold</a>
 


 </div>
        <div class="summary"><h2>引言</h2>
<p>近期一直在Linux下工作,使用Ubuntu 11.10,经过一段时间的使用和磨合,终于打造出一套适合自己的高效Linux桌面环境,之前也在博客中零散的写了几篇文章分享,在此做一番总结.</p>
<p>首先先放出桌面截图
<img alt="Awesome 桌面截图" src="/upload/MyDesktop.png" /></p>
<h2>Awesome</h2>
<p>使用Ubuntu 11.10不习惯默认搭载的Unity,Gnome 3也不尽人如意,也使用xfce/openbox,但使用都不是很好,没有Windows的体验好,然后接触了Awesome,Awesome是一款平铺式窗体管理器,Awesome会去除窗口的标题栏等.会使窗口尽量小的占用桌面空间,而且大部分窗口操作都可以通过键盘来进行操作,免除了各位身为键盘高手的码农们频繁拿鼠标的烦恼.</p>
<h3>安装</h3>
<p>Awesome Ubuntu下安装十分简单:</p>
<div class="codehilite"><pre>sudo apt-get install awesome
</pre></div>


<h3>配置</h3>
<h4>拷贝配置文件</h4>
<p>Awesome 的配置文件使用lua脚本,所以如果你会lua配置起来会得心应手,我们先拷贝一个基础配置文件,然后在这个基础上进行更改:</p>
<div class="codehilite"><pre>cp /etc/xdg/awesome/rc.lua ~/.config/awesome <span class="c">#  ~/.confg下如没有awesome则手动创建</span>
</pre></div>


<h4>配置自动启程序 ...</h4> <a class="btn btn-info xsmall" href="http://www.linuxzen.com/awesometmuxgnomedoda-zao-gao-xiao-linuxzhuo-mian-huan-jing.html">read more</a></div>
    </div>	
				
    
 
        

 

    <div class='article'>
        <a href="http://www.linuxzen.com/linuxgao-xiao-gong-zuo-ping-pu-shi-chuang-ti-guan-li-qi-awesome.html"><h2>Linux高效工作----平铺式窗体管理器Awesome</h2></a>
        <div class= "well small"> 四 25 十月 2012

by <a class="url fn" href="http://www.linuxzen.com/author/cold.html">cold</a>
 


 </div>
        <div class="summary"><p>在Linux桌面环境下开发,总想更高效的工作,我已经装备了Gnome Do和terminator,但是我还是觉得不够快我更加希望能解放右手(当然不是找个妹子戒撸,只是右手的鼠标),而且terminator在跑的东西过多的时候开多个terminator不太好管理,这时候一个词进入了我的眼睛平铺式窗体管理器,与传统窗体管理器不同的是平铺式窗体管理器的窗口不会重叠,窗口会被自动调整成正好铺满全屏的尺寸,也就是说无论开多少窗口都会把屏幕占满,如果想象力贫乏就装一个试试吧:</p>
<p>Awesome是一款运行在Unix和类Unix(Linux/FreeBSD)等系统上的一款平铺式窗体管理器,有占用资源小,易于管理和操作等等有点,这里不罗嗦这些说说安装,Ubuntu安装很简单</p>
<div class="codehilite"><pre>sudo apt-get install awesome
</pre></div>


<p>安装好后登出会话选择awesome登录,然后你是否茫然无知没办法工作了?先简单介绍下使用方法:</p>
<p>按<code>Win键+1~9</code>可以切换桌面,</p>
<p>没有菜单对吧 其实再右上角点一下就会出来一个菜单,打开程序会发现标题栏状态栏什么都木有了大大节省了桌面空间,可问题来了,怎么关闭啊不用担心</p>
<p>按 <code>Win键+Shift+C</code>可以关闭当前窗口</p>
<p>打开默认终端 <code>Win键+Enter</code>就可以打开终端</p>
<p>可以按住 <code>Win键+Shift ...</code></p> <a class="btn btn-info xsmall" href="http://www.linuxzen.com/linuxgao-xiao-gong-zuo-ping-pu-shi-chuang-ti-guan-li-qi-awesome.html">read more</a></div>
    </div>	
				
    
 
        

 

    <div class='article'>
        <a href="http://www.linuxzen.com/linuxzhuo-mian-gao-xiao-gong-zuo-shi-yong-gnome-do.html"><h2>Linux桌面高效工作----使用Gnome DO</h2></a>
        <div class= "well small"> 六 01 九月 2012

by <a class="url fn" href="http://www.linuxzen.com/author/cold.html">cold</a>
 


 </div>
        <div class="summary"><p>不知大家是否和我一样在win下系统win+r输入命令来快速启动程序,这两天在Linux下碰到一个比这更爽,更快的软件,<code>Gnome Do</code>.</p>
<p>Gnome Do能根据用户键入的内容进行自动匹配，从而快速打开系统中已有的程序、文件、书签等。不仅如此，GNOME Do 还包括插件，从而能够做更多事,</p>
<p>比如你安装了pidgin插件只需输入联系人的名字即可打开与他/她的会话,安装了file这个插件输入文件/目录的名字即可打开目录或文件,</p>
<p>当然还有一个不足就是不支持中文</p>
<p>ubuntu用户可以按照下面安装:</p>
<div class="codehilite"><pre>sudo apt-get install gnome-do
</pre></div>


<p>启动之后Gnome do不会停留任务栏或通知栏只需按<code>Win(ubuntu下称为super)+Space</code>即可启动,输入你想启动的应用程序名字即可打开/关闭等操作.是不是很酷提高不少的工作效率</p> <a class="btn btn-info xsmall" href="http://www.linuxzen.com/linuxzhuo-mian-gao-xiao-gong-zuo-shi-yong-gnome-do.html">read more</a></div>
    </div>	
				
    
 
        

 

    <div class='article'>
        <a href="http://www.linuxzen.com/tui-jian-liang-kuan-bu-cuo-de-zhong-duan-ruan-jian.html"><h2>推荐两款不错的终端软件</h2></a>
        <div class= "well small"> 三 29 八月 2012

by <a class="url fn" href="http://www.linuxzen.com/author/cold.html">cold</a>
 


 </div>
        <div class="summary"><p>一直在Linux下做开发,一个好用的终端软件能帮你节省很多时间和精力</p>
<p>作为一个经常喜欢敲命令的人,可能要同时做很多操作,Linux各个桌面的窗口切换有多那啥,这里就不吐槽了,
我总是在想要做另外一个操作,但又不想结束当前的工作,之前我习惯于再打开一个终端,但是后来终端越来越多导致我想找回原来的工作的时候就变的很费力,而且对桌面有洁癖的人不允许任务栏太杂
后来发现了一款终端软件terminator,它支持分割终端,并可以在终端中快速切换.还有一款下拉式的终端软件Guake可以随意呼出隐藏.下面就一一介绍一下.</p>
<h2>1 安装Terminator</h2>
<div class="codehilite"><pre>sudo apt-get install terminator
</pre></div>


<h2>2 使用</h2>
<p>打开Termintor按<code>Ctrl-E</code>(注意是大E要按住Shift)可以垂直分割终端
<code>Ctrl-O</code> 可水平分割终端
按住Alt然后按上下左右可以在不同的分割窗中切换
<code>Ctrl-D</code> 可以关闭分割窗</p>
<h3>2.1 配置</h3>
<p>terminator配置文件在<code>~/.config/terminator/config</code>
可以通过这个配置文件配置<code>terminator</code>的字体和颜色</p>
<div class="codehilite"><pre><span class="n">font</span> <span class="o">=</span> <span class="n">Monaco</span> <span class="mi">10</span>  <span class="c1">#设置体字</span>
<span class="n">background_color</span> <span class="o">=</span> <span class="s">&quot;#204070&quot;</span> <span class="c1"># 背景颜色 ...</span></pre></div> <a class="btn btn-info xsmall" href="http://www.linuxzen.com/tui-jian-liang-kuan-bu-cuo-de-zhong-duan-ruan-jian.html">read more</a></div>
    </div>	
				
    
 
        

 

    <div class='article'>
        <a href="http://www.linuxzen.com/shi-yong-linux-shellshi-shi-jian-ce-wen-jian-bian-geng.html"><h2>使用Linux shell实时检测文件变更</h2></a>
        <div class= "well small"> 五 18 五月 2012

by <a class="url fn" href="http://www.linuxzen.com/author/cold.html">cold</a>
 


 </div>
        <div class="summary"><p>使用python做web开发,现在流行使用uwsgi调用python程序,但是使用uwsgi一段时间发现有一个弊端,就是每次更改源代码后必须重启uwsgi才能生效,包括更改模板文件也是,我是个懒人,再经过一段时间反复的更改-重启后我终于忍受不了,决定写一个脚本来定时程序目录的文件改动,并及时自动重启uwsgi,来解放我的双手可以不用理会这些琐碎的重启工作. 用了点时间来编写了一个脚本用来判断是否更改,然后判断是否需要重启uwsgi.</p>
<p>下面放出脚本内容:</p>
<div class="codehilite"><pre><span class="c">#!/bin/bash</span>
<span class="c"># Author      : cold</span>
<span class="c"># Homepage    : http://www.linuxzen.com</span>
<span class="c"># Filename    : checkchange.sh</span>
<span class="c"># Useage      : sh checkchange.sh [dir]</span>
checkisdir<span class="o">()</span>
        <span class="c"># Have one argument</span>
        <span class="c"># The argument is a directory</span>
        <span class="k">for </span>i in <span class="sb">`</span>ls <span class="nv">$1</span> | sed -e <span class="s1">&#39;s/ /\n/g&#39;</span><span class="sb">`</span>
        <span class="k">do ...</span></pre></div> <a class="btn btn-info xsmall" href="http://www.linuxzen.com/shi-yong-linux-shellshi-shi-jian-ce-wen-jian-bian-geng.html">read more</a></div>
    </div>	
				
    
 
        

 

    <div class='article'>
        <a href="http://www.linuxzen.com/yong-pythonxie-de-zhong-duan-xia-de-fan-yi-gong-ju.html"><h2>用Python写的终端下的翻译工具</h2></a>
        <div class= "well small"> 一 23 四月 2012

by <a class="url fn" href="http://www.linuxzen.com/author/cold.html">cold</a>
 


 </div>
        <div class="summary"><p>为什么写这个程序,为什么不给这个程序配备gui?原因很简单,因为我是一个命令行控,Linux习惯了不习惯了鼠标,总觉得点着不如敲命令快,各位在看这篇文章就说明和本人有相同的爱好.这个用python写的翻译工具是通过google来实现的,由于google返回的数据不是很规范(或者说我没有找到规律),现在前三项能正常显示(源词,翻译结果,和汉语拼音).下面的词性和其他释义可能不同,见谅,望大神可以指点下小弟和帮小弟完善,这里赶紧不尽.</p>
<p>好了不费话了,下面放代码:</p>
<div class="codehilite"><pre><span class="c">#!/usr/bin/env python</span>
<span class="c"># -*-coding:utf8 -*-</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">#=============================================================================</span>
<span class="sd">#     FileName: translate.py</span>
<span class="sd">#         Desc: To translate with zh to en or en2zh</span>
<span class="sd">#       Author: cold</span>
<span class="sd">#        Email: wh_linux@126.com</span>
<span class="sd">#     HomePage: http://www.linuxzen.com</span>
<span class="sd">#      Version ...</span></pre></div> <a class="btn btn-info xsmall" href="http://www.linuxzen.com/yong-pythonxie-de-zhong-duan-xia-de-fan-yi-gong-ju.html">read more</a></div>
    </div>	
				
    
 
        

 

    <div class='article'>
        <a href="http://www.linuxzen.com/lvskeepalivedshi-xian-gao-ke-yong-qun-ji-pei-zhi-xiang-jie.html"><h2>lvs+keepalived实现高可用群集配置详解</h2></a>
        <div class= "well small"> 一 16 四月 2012

by <a class="url fn" href="http://www.linuxzen.com/author/cold.html">cold</a>
 


 </div>
        <div class="summary"><p>lvs是一个开源的软件，由毕业于国防科技大学的章文嵩博士于1998年5月创立(中国人的项目)，可以实现LINUX平台下的简单负载均衡。LVS是Linux Virtual Server的缩写，意思是Linux虚拟服务器。本文将介绍lvs结合keepalived实现一个高科用的Linux群集系统.</p>
<p>lvs有三种工作模式NAT(地址转换),IP Tunneling(IP隧道)、Direct Routing(直接路由)。
工作效率最低的是NAT模式,但NAT模式可以用于各种系统,各种环境的负载均衡,只需要一个公网ip即可实现
IP Tunneling模式调度器将连接分发到不同的后端real server,然后由real server处理请求直接相应给用户,大大提高了调度器的调度效率,后端real server没有物理位置和逻辑关系的限制,后端real server可以在Lan/Wlan,但是后端real server必须支持IP隧道协议.
DR(Direct Routing)是效率最高的,与IP Tunneling类似,都是处理一般连接,将请求给后端real server,然后由real server处理请求直接相应给用户,Direct Routing与IP Tunneling相比，没有IP封装的开销，但由于采用物理层 ...</p> <a class="btn btn-info xsmall" href="http://www.linuxzen.com/lvskeepalivedshi-xian-gao-ke-yong-qun-ji-pei-zhi-xiang-jie.html">read more</a></div>
    </div>	
				
            <div class="pagination">
<ul>
    <li class="prev disabled"><a href="#">&larr; Previous</a></li>

    <li class="active"><a href="http://www.linuxzen.com/tag/linux.html">1</a></li>
    <li class=""><a href="http://www.linuxzen.com/tag/linux2.html">2</a></li>
    <li class=""><a href="http://www.linuxzen.com/tag/linux3.html">3</a></li>

    <li class="next"><a href="http://www.linuxzen.com/tag/linux2.html">Next &rarr;</a></li>

</ul>
</div>    
 
  
        </div>
        
        <div class="span3">

            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Site
                </li>
            
                <li><a href="http://www.linuxzen.com/archives.html">Archives</a>
                <li><a href="http://www.linuxzen.com/tags.html">Tags</a>
                <li><a href="http://www.linuxzen.com/feeds/all.atom.xml" rel="alternate">Atom feed</a></li>
                            </ul>
            </div>


                        <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Categories
                </li>
                
                                <li><a href="http://www.linuxzen.com/category/linux.html">Linux</a></li>
                                <li><a href="http://www.linuxzen.com/category/mysql.html">MySQL</a></li>
                                <li><a href="http://www.linuxzen.com/category/python.html">Python</a></li>
                                <li><a href="http://www.linuxzen.com/category/vim.html">Vim</a></li>
                                <li><a href="http://www.linuxzen.com/category/shell.html">shell</a></li>
                                <li><a href="http://www.linuxzen.com/category/jian-kong.html">监控</a></li>
                                <li><a href="http://www.linuxzen.com/category/fu-zai-jun-heng.html">负载均衡</a></li>
                                   
            </ul>
            </div>
            

                        <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Links
                </li>
            
                            <li><a href="http://eleveni386.7axu.com">eleven</a></li>
                        </ul>
            </div>
            

            
        </div>  
    </div>     </div> 
<footer>
<br />
<p><a href="http://www.linuxzen.com">cold's world</a> &copy; cold 2012</p>
</footer>

</div> <!-- /container -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="http://twitter.github.com/bootstrap/assets/js/bootstrap-collapse.js"></script>
<a href="https://github.com/coldnight/coldnight.github.com"><img style="position: absolute; top: 40px; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png" alt="Fork me on GitHub" /></a>
 
</body>
</html>